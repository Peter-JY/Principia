\documentclass[10pt, a4paper, twoside]{basestyle}

\usepackage{pgfornament}
\usepackage[Mathematics]{semtex}
\usepackage{chngcntr}

\counterwithout{equation}{section}
\renewcommand{\thesubsection}{\arabic{subsection}}

\setcounter{MaxMatrixCols}{20}

% REMOVE BEFORE FLIGHT: move to semtex.
\newlength{\medianToZeroTop}
\newcommand\zeroBL[1]{\multicolumn{1}{l}{\rlap{\smash{\text{{#1$0$}}}}}}
\newcommand\zeroBR[1]{\multicolumn{1}{r}{\llap{\smash{\text{{#1$0$}}}}}}
\newcommand\zeroTR[1]{\multicolumn{1}{r}{\llap{\smash{\setlength{\medianToZeroTop}{\heightof{#1$0$}-1ex}\raisebox{-\medianToZeroTop}{\text{{#1$0$}}}}}}}

%%%% Shorthands.
\DeclareMathOperator{\bias}{\mathit{bias}}
% Rounding brackets will be heavily nested, and reading the nesting depth is critically important,
% so we make them grow for readability.
\newcommand{\round}[1]{\doubleSquareBrackets*{#1}}
\newcommand{\roundToZero}[1]{\doubleSquareBrackets{#1}_0}
\newcommand{\hex}[1]{{_{16}}\mathrm{#1}}

\newcommand{\bigradient}[4]{\det\begin{pmatrix}\pa{#1}_{#2}\\\pa{#3}_{#4}\end{pmatrix}}

%%%% Title and authors.

\title{A nearly correctly-rounded cube root}
\date{TODO(egg): \printdate{2017-03-36}}
\author{Robin~Leroy (eggrobin)}
\begin{document}
\maketitle
\noindent
This document describes the error analysis of the real cube root function \texttt{Cbrt} implemented in \texttt{numerics/cbrt.cpp}.

\section*{On some abridged root-finding methods}

We start with a historical overview of a family of root-finding methods.

In \cite{FantetdeLagny1691a}, Lagny first presents the iterations\begin{align}
\FunctionBody*{a}{\tfrac{1}{2}a+\sqrt{\tfrac{1}{4}a^2+\frac{b}{3a}}}\text, \label{LagnyIrrationalCubeRootiteration}
\intertext{hereafter the \emph{irrational method}, and}
\FunctionBody*{a}{a+\frac{ab}{3a^3+b}}\text, \label{LagnyRationalCubeRootiteration}
\end{align}
the \emph{rational method}, for the computation of the cube root
$\cuberoot{a^3+b}$, mentioning the existence of similar methods for arbitrarily
higher powers.
In \cite{FantetdeLagny1691b} the above methods are again given, with an outline
of the general method for higher powers, and a mention of their applicability to
finding roots of polynomials other than $z^p-r$.

That general method is given in detail in \cite[19]{FantetdeLagny1692}.
Modernizing the notation, the general rule is as follows for finding a root of the monic
polynomial of degree $p\geq2$\[
f\of{z}\DefineAs z^p + c_1 z^{p-1} + \dotsb + c_{p-1} z + c_p \DefinitionOf z^p - R\of{z}
\]
with an initial approximation $a$.

Separate the binomial expansion of $\pa{x+\tfrac{1}{2}a}^p$ into alternating sums of
degree $p$ and $p-1$ in $z$,\begin{align*}
S_1\DefineAs\sum{\substack{k=0\\2\Divides k}}[p]\binom{p}{k}x^{p-k}\pa{\tfrac{1}{2}a}^k&\text{ and }
S_2\DefineAs\sum{\substack{k=0\\2\DoesNotDivide k}}[p]\binom{p}{k}x^{p-k}\pa{\tfrac{1}{2}a}^k\text,
\intertext{and consider the following polynomials, of degree $p$ and $p-1$ in $x$ for almost all $a$:}
E_{p}\DefineAs S_1-\tfrac{1}{2}R\of{x+\tfrac{1}{2}a}&\text{ and }
E_{p-1}\DefineAs S_2-\tfrac{1}{2}R\of{x+\tfrac{1}{2}a}\text.
\end{align*}
Let $E_{n-1}$ be the remainder of the polynomial
division\footnote{While the rest of the method is a straightforward translation, this step bears some explanations; its description in \cite{FantetdeLagny1692} is
% TODO(egg): Right Single Quotation Mark leads to incorrect spacing in French, so we use Apostrophe here (which
% gets converted to Right Single Quotation Mark by the typesetting engine).  Figure out what is going on.
\begin{quote}\textfrench{De ces deux égalitez, ou priſes ſéparément, ou comparées enſemble ſelon la methode des problêmes plus que déterminez tirez en une valeur d'$x$ rationelle, ou ſimplement d'un degré commode.}
\end{quote}
It is assumed that the reader is familiar with this ``comparison according to the method of
more-than-determined problems''.
While the application of the root-finding method is described in painstaking detail in \cite{FantetdeLagny1733},
which outlines the treatment of overdetermined problems, it is perhaps this remark from \cite[494]{FantetdeLagny1697} which lays it out most clearly:
\begin{quote}\textfrench{Il n'y a rien de nouveau à remarquer ſur les Problemes plus que déterminez du quatriéme degré. La Regle générale eſt d'égaler tout à zero, \& de diviſer la plus haute équation par la moins élevée, ou l'également élevée l'une par l'autre, continuellement juſques à ce que l'on trouve le reſte ou le diviſeur le plus ſimple.}
\end{quote}}
of $E_{n+1}$ by $E_{n}$; its degree is $n-1$ for almost all $a$.
The iteration is $\FunctionBody{a}{x+\frac{1}{2}a}$, where $x$ is a root of $E_{2}$ for the irrational method,
and the root of $E_{1}$ for the rational method. Its order is $p$.

Modern calculus allows us to give a more straightfoward expression for the rational method than was available to Lagny;
the proof of the following equivalence will be given at the end of this section.

\begin{proposition}
The iteration of Lagny’s rational method for a polynomial $f$ of degree $p$ is\begin{equation}
a\mapsto a + \pa{p-1}\frac{\pa{1/f}^{\pa{p-2}}\of{a}}{\pa{1/f}^{\pa{p-1}}\of{a}}\text.\label{LagnyRationaliteration}
\end{equation}
\end{proposition}

\subsection*{Names}
The iteration (\ref{LagnyRationaliteration}) is a special case of the \foreign{Algorithmen $\pa{A^λ_ω}$} defined by Schröder for an
arbitrary polynomial $f$ in \cite{Schröder1870}, equation (69) and p.~350; specifically, it is $\pa{A^0_{p-1}}$.
As seen in the proof of the proposition, it is also a special case of Householder’s  equation (14) from \cite[169]{Householder1970},
which generalizes it by substituting $\frac{f}{g}$ for $f$, and letting $f$ be an arbitrary analytic function. The case
$g\Identically1$ is mentioned in theorem 4.4.2, and that expression is given explicitly in \cite{SebahGourdon2001}.

For $p=2$ and $f$ an arbitrary polynomial, (\ref{LagnyRationaliteration}) is Newton's method, presented by Wallis in
\cite[338]{Wallis1685}.

For $p=3$ and $f$ an arbitrary polynomial, it is Halley's rational method, given in \cite[142--143]{Halley1694} in
an effort to generalize\footnote{Lagny's method is general, in that an iteration is given for any
polynomial, albeit one whose order changes with the degree. However, while he refers to its
results---and even corrects a misprint therein---, Halley
did not have access to a copy of \cite{FantetdeLagny1692},
\begin{quote}
Has Regulas, cum nondum librum videram, ab amico communicatas habui
\end{quote}
and it appears that said friend communicated only the formulæ for the cube and fifth root, as opposed to the
general method and its proof, as Halley writes
\begin{quote}
[...] \emph{D. de Lagney} [...] qui cum totus fere ſit in eliciendis Poteſtatum purarum radicibus,
præfertim Cubicâ, pauca tantum eaque perplexa nec ſatis demonſtrata de affectarum radicum
extractione ſubjungit.
\end{quote}
or, about Lagny's irrational method for the fifth root,
\begin{quote}
Author autem nullibi inveniendi methodum ejuſve demonſtrationem concedit,
etiamſi maxime deſiderari videatur [...].
\end{quote}
Being unaware of this generality, Halley sets out to generalize (\ref{LagnyIrrationalCubeRootiteration}) and (\ref{LagnyRationalCubeRootiteration}) to
arbitrary polynomials, and does so by keeping the order constant.} Lagny's (\ref{LagnyRationalCubeRootiteration}).
It is usually simply known as Halley's method, as the irrational method---which likewise generalizes Lagny's irrational
method for $p=3$ while retaining constant order as the degree changes---has comparatively fallen into obscurity;
see \cite{ScavoThoo1995}.

Considering, as remarked by \cite[334]{Schröder1870}, that a method can often
be generalized from arbitrary polynomials or rational functions to arbitrary
analytic functions, we call the iteration (\ref{LagnyRationaliteration})\begin{itemize}[nosep]
\item Newton’s method when $p=2$, for arbitrary $f$;
\item Lagny’s rational method when $p>2$ and $f$ is a polynomial of degree $p$;
\item Halley’s (rational) method when $p=3$ and $f$ is not a polynomial of degree $3$;
\item the Lagny--Schröder method of order $p$ otherwise.
\end{itemize}
We do not simply call this last case ``Schröder’s method'', as it is only a special case of the methods
defined in \cite{Schröder1870}, so that the expression would be ambiguous. 

Note that we avoid the name ``Householder’s method'' which appears in \cite{SebahGourdon2001} and ulterior works, as it
is variably used to refer to either (\ref{LagnyRationaliteration}) or to a method from a different family, namely $\gj_{p+1}$
from \cite[168]{Householder1970}, equation (7), taking $Γ_{p+1}\Identically0$ in the resulting iteration;
$\gj_3$ is\footnote{We are grateful to Peter Barfuss for this observation.} the iteration given in section 3.0.3
of \cite{SebahGourdon2001}. As mentioned by Householder, both of those were described by Schröder a century prior
anyway: Householder’s (7) is Schröder’s (18) from
\cite[327]{Schröder1870}.

\subsection*{Bibliographic note}
Our foray into the history of these methods was prompted by finding the ``historical background'' section of
\cite{ScavoThoo1995} while looking for a reference for Halley’s method: it is mentioned therein that this
method, as applied to the cube root, is due to Lagny.

Searching for Lagny’s work led us to the historical note \cite{Cantor1861}, wherein a note by the editors Terquem and Gerono reads
\begin{quote}\textfrench{%
Naturellement, en mathématiques, séjour des propositions irréfragables, identiques en toute langue, en tout pays, ces rencontres ne peuvent manquer d'être assez fréquentes; nulle part les plagiats \emph{effectifs} sont si rares, et les plagiats \emph{apparents} si communs que dans la science exacte par excellence; mais les signaler est un devoir, un service rendu à l'histoire scientifique.}
\end{quote}
The editors then quote a letter by Prouhet, wherein he gives a reference to \cite{FantetdeLagny1692}.

Lagny’s work proved far more extensive than we expected: besides the above root finding methods for arbitrary
polynomials, it contains an error analysis, and even a discussion of the principles of performance analysis
based on a decomposition in elementary operations on decimal digits.

We observed that the higher-order examples corresponded to the well-known higher order method attributed to
Householder in \cite{SebahGourdon2001}. Looking for properties of these methods in \cite{Householder1970}
so as to prove that observation, we found that they are attributed to Schröder therein.
As mentioned in the translator’s note to the English translation
\cite{SchröderStewart1993} of \cite{Schröder1870} by Stewart,
\begin{quote}
A.~S.~Householder used to claim you could evaluate a paper on
root finding by looking for a citation of Schröder’s paper. If it was
missing, the author had probably rediscovered something already
known to Schröder.
\end{quote}
It is quite possible that the irrational method could be expressed using Schröder’s methods in one way or another, but while
the result would probably be more convenient, it is unlikely to be something well-known, as irrational methods are far less
popular nowadays.

Prouhet’s letter in \cite{Cantor1861} ends with these words:
\begin{quote}\begin{center}\textfrench{%
Tout cela est fort abrégé; mais qui nous délivrera des méthodes abrégées, qui n'en finissent pas?}
\end{center}\end{quote}

% This cul-de-lampe prevents the typesetting engine having too little to fill this page without setting the
% giant matrix in it, thereby overflowing into the bottom margin.
\begin{center}\pgfornament[width = .2\linewidth]{59}\end{center}

\subsection*{Proof of the proposition}

We now prove the above proposition, which, substituting the definition of Lagny’s rational method, is that
\[x+\tfrac{1}{2}a = a + \pa{p-1}\frac{\pa{1/f}^{\pa{p-2}}\of{a}}{\pa{1/f}^{\pa{p-1}}\of{a}}\DefinitionOf ψ\of{a}\]
if $x$ is the root of $E_1$.

\begin{proof}
Let $E_p = d_0 x^p + \dotsb + d_p$, $E_{p-1} = e_0 x^{p-1} + \dotsb + e_{p-1}$.
As shown in \cite[52--54]{Householder1970}, the polynomial remainders $E_k$ are given up to a constant factor by
\cite[19]{Householder1970} equation (23), \idest, for some $α$,\[
\frac{E_k}{α_k} = \bigradient{E_p}{p-1-k}{E_{p-1}}{p-k}\text,
\]
where the expression on the right-hand side is the \emph{bigradient} defined in \cite{Householder1968} (3.2)
or \cite[19]{Householder1970} (20),\[
\frac{E_k}{α_k} = \det\begin{pmatrix}
d_0    & d_1    & d_2 & \multicolumn{3}{c}{\cdots} & d_{2\pa{p-k}-3} & x^{p-k-2} E_p \\
       & d_0    & d_1 & \multicolumn{3}{c}{\cdots} & d_{2\pa{p-k}-4} & x^{p-k-3} E_p \\
       &        & \ddots  &      &                 &                 & \vdots \\
       &        &         & d_0  & d_1 & \cdots    & d_{p-k-1}       & x^{0} E_p \\
\zeroBL\huge&   &         &      & e_0 & \cdots    & e_{p-k-2}       & x^{0} E_{p-1} \\
       &        &         &\adots&     &           &                 & \vdots \\
       &        & e_0 & \multicolumn{3}{c}{\cdots} & e_{2\pa{p-k}-4} & x^{p-k-2} E_p \\
       & e_0    & e_1 & \multicolumn{3}{c}{\cdots} & e_{2\pa{p-k}-4} & x^{p-k-2} E_p \\
e_0    & e_1    & e_2 & \multicolumn{3}{c}{\cdots} & e_{2\pa{p-k}-3} & x^{p-k-1} E_p \\
\end{pmatrix}\DefinitionOf\det\matE_k\text,
\]
where $d_n\DefineAs0$ for $n>p$, and $e_n\DefineAs0$ for $n>p-1$.

In particular, for $k=1$,\[
\matE_1=\begin{pmatrix}
d_0    & d_1    & d_2    & \cdots & d_{p-3} & d_{p-2} & d_{p-1} & d_p     &      &\zeroTR\huge& x^{p-3} E_p     \\
       & d_0    & d_1    & \cdots & d_{p-4} & d_{p-3} & d_{p-2} & d_{p-1} & d_p     &         & x^{p-4} E_p     \\[1ex]
       &        & \ddots &        &         &         &         &         &         & \ddots  & \vdots          \\[1ex]
       &        &        & d_0    & d_1     & d_2     & \multicolumn{3}{c}{\cdots}  & d_{p-2} & x^{0} E_p       \\
\zeroBL\huge&   &        &        & e_0     & e_1     & \multicolumn{3}{c}{\cdots}  & e_{p-3} & x^{0} E_{p-1}   \\[1ex]
       &        &        & \adots &         &         &         &         &         & \adots  & \vdots          \\[1ex]
       &        & e_0    & \cdots & e_{p-5} & e_{p-4} & e_{p-3} & e_{p-2} & e_{p-1} &         & x^{p-5} E_{p-1} \\
       & e_0    & e_1    & \cdots & e_{p-4} & e_{p-3} & e_{p-2} & e_{p-1} &         &         & x^{p-4} E_{p-1} \\
e_0    & e_1    & e_2    & \cdots & e_{p-3} & e_{p-2} & e_{p-1} &         &      &\zeroBR\huge& x^{p-3} E_{p-1} \\
\end{pmatrix}\text.
\]
Observe that, since the value of $x$ used in the rational method is the root of $E_1$, for that value of $x$,
$\det \matE_1 = 0$, \idest, $\matE_1$ is singular.
\begin{lemma}[Left as an exercise to the reviewer]
The matrix $\matE_1$ is singular if and only if $\matC\of{x+\frac{1}{2}a}$ is singular, where\[
\matC\of{Ψ}\DefineAs\begin{pmatrix}
Ψ - a  & c_0     &&&\zeroTR\huge\\
-1     & c_1     & c_0 \\
0      & c_2     &        & \ddots \\
\vdots & \vdots  & \ddots &        & c_0 \\
0      & c_{p-1} & \cdots & c_2    & c_1
\end{pmatrix}
\] and $c_0\DefineAs1$.
\begin{proof}
Observe that:\begin{itemize}
\item since $\det \matE_1$ is a polynomial of degree $1$, all terms divisible by $x^2$ must cancel out in the Laplace expansion of that
determinant on the last column, the determinant is equal to\[
\pm δ_1 xE_p \mp δ_2 E_p \pm δ_3 E_{p-1} \mp δ_4 xE_{p-1}\text,
\]
where the $δ_i$ are determinants of real matrices;
\item by the same reasoning, only the linear and constant terms of the polynomials remain in the above expression, which simplifies to\[
\pm δ_1 d_p x \mp δ_2 \pa{d_{p-1}x + d_p} \pm δ_3 \pa{e_{p-2}x + e_{p-1}} \mp δ_4 e_{p-1}x\text;
\]
\item $E_p-E_{p-1}=S_1-S_2$, which, by Lagny’s \foreign{\textfrench{theoreme fondamental}}
\cite[17]{FantetdeLagny1692}, is $\pa{x-\frac{1}{2}a}^p$.
\end{itemize}
The proof is a calculation.
\end{proof}
\end{lemma}
The proposition follows from the lemma and theorem 4.4.2 from \cite[169]{Householder1970}:
$ψ\of{a}$ is Householder’s (14) with $g\Identically 1$; for that
value of $g$, theorem 4.4.2 states that (14) is the solution of (12) from the same page, which is
$\det\matC\of{ψ\of{a}}=0$.
By the lemma, for the value of $x$ in Lagny’s rational method, $x+\frac{1}{2}a$ solves that equation.
\end{proof}

\section*{Computing a real cube root}

We now turn to the computation in \texttt{numerics/cbrt.cpp}.

\subsection*{Overview}
The general approach to compute the cube root of $y>0$ is the same as the one described in \cite{KahanBindel2001}:
\begin{enumerate}
\item integer arithmetic is used to get a an initial quick approximation $q$ of $\cuberoot y$;
\item a root finding method is used to improve that that to an approximation $ξ$ with a third of the precision;
\item $ξ$ is rounded to a third of the precision, resulting in the rounded approximation $x$ whose cube $x^3$ can be computed exactly;
\item a single high order iteration of a root finding method is used to get the final result.
\end{enumerate}

\subsection*{Notation}
We define the fractional part as $\FractionalPart a\DefineAs a-\Floor a\in\intclop{0}{1}$, regardless of the sign of $a$.

The quantities $p\in\N$ (precision in bits) and $\bias\in\N$ are defined as in IEEE 754-2008.

We use capital Latin letters fixed-point numbers involved in the computation, and $A>0$ for the normal floating-point number $a>0$ reinterpreted as a binary fixed-point number with $p-1$ bits after the binary point\footnote{The implementation uses integers (obtained by multiplying the fixed-point numbers by $2^{p-1}$). For consistency with \cite{KahanBindel2001} we work with fixed-point numbers here. Since we do not multiply fixed point numbers together, the expressions are unchanged.},\begin{align*}
  A &\DefineAs \bias + \Floor{\log_2 a} + \FractionalPart \pa{2^{-\Floor{\log_2 a}}a}\\
    &= \bias + \Floor{\log_2 a} + 2^{-\Floor{\log_2 a}}a - 1\text,\\
\intertext{and \emph{vice versa},}
  a &\DefineAs 2^{\Floor A-\bias} \pa{1+\FractionalPart{A}}\text.\\
\end{align*}
This corresponds to \cite{KahanBindel2001}'s $B+K+F$.

For both fixed- and floating-point numbers, given $α\in\R$, we write $\round{α}$ for the nearest representable number (rounding ties to even).
For fixed-point numbers, we write $\roundToZero{α}$ for directed rounding towards $0$ to the fixed-point precision (as in division implemented with integer division).
We write the unit roundoff $u\DefineAs2^{-p}$, and, after \cite[63]{Higham2002}, $γ_n\DefineAs\frac{nu}{1-nu}$.

To quote \cite{Trefethen1997}, ``If rounding errors vanished, 95\% of numerical analysis would remain''.
While we keep track of rounding errors throughout, they are of very little importance until the last step;
when it is convenient to solely study the truncation error, we work with ideal quantities affected with a
prime, which correspond to their primeless counterparts by removal of all intervening roundings.

Except in the section on rescaling, the input $y$ and all intervening floating-point numbers are taken to be normal; the rescaling performed to avoid overflows also avoids subnormals.

\subsection{Quick approximation}
The quick approximation $q$ is computed using fixed-point arithmetic as\[
Q\DefineAs C + \roundToZero{\frac{Y}{3}}\text,
\]
where the fixed-point constant $C$ is defined as\footnote{Note
that there is a typo in the corresponding expression $C\DefineAs\pa{B-0.1009678}/3$ in \cite{KahanBindel2001}; a factor of $2$ is missing on the bias term.}\[
C\DefineAs \round{\frac{2\bias-Γ}{3}}
\]
for some $Γ\in\R$.

Let $ε \DefineAs \frac{q}{\sqrt[3] y}-1$,  % TODO(egg): Figure out why \cuberoot does not render here.
so that $\cuberoot y\pa{1+ε}=q$; the relative error of $q$ as an approximation of $\cuberoot y$ is $\abs ε$.
Considering $Y$, $Q$, $q$, and $ε$ as functions of $y$, we have\begin{align*}
Y\of{8y} &= Y\of{y} + 3\text,\\
Q\of{8y} &= Q\of{y} + 1\text,\\
q\of{8y} &= 2q\of{y}\text,\\
ε\of{8y} &= ε\of{y}\text,
\end{align*}
so that the properties of $ε$ need only be studied on some interval of the form $\intclop{η}{8η}$.

Pick $η\DefineAs2^{\Floor{Γ}}$, and $y\in\intclop{η}{8η}=\intclop{2^{\Floor{Γ}}}{2^{\Floor{Γ}+3}}$,
so that $\log_2 y\in\intclop{\Floor{Γ}}{\Floor{Γ}+3}$. Let $k\DefineAs\Floor{\log_2 y}-\Floor{Γ}$; note that $k\in\set{0,1,2}$.
Let $f\DefineAs\FractionalPart\pa{2^{-\Floor{\log_2 y}}y}\in\intclop{0}{1}$.
Up to at most $3$ half-units in the last place from rounding ($2$ from the directed rounding of the division
by three and $1$ from the definition of $C$), we have\begin{align*}
Q\approx Q'\DefineAs&\bias+\frac{\Floor{\log_2 y}}{3}+\frac{\FractionalPart\pa{2^{-\Floor{\log_2 y}}y}-Γ}{3}\text,\\
=&\bias+\frac{\Floor{Γ}+k}{3}+\frac{f-Γ}{3}\text,\\
=&\bias+\frac{k+f-\FractionalPart Γ}{3}\text.
\end{align*}
Since $k\in\intclos{0}{2}$, the numerator $k+f-\FractionalPart Γ$ lies in $\intopen{-1}{3}$.
Further, it is negative only if $k=0$, so that\begin{align*}
\Floor{Q'}&=\begin{cases}
\bias - 1 & \text{if }k = 0\text{ and }\FractionalPart Γ > \FractionalPart\pa{2^{-\Floor{Γ}}y}\text, \\
\bias & \text{otherwise,}
\end{cases}\text{ and}\\
\FractionalPart{Q'}&=\begin{cases}
1+\frac{f-\FractionalPart Γ}{3} & \text{if }k = 0\text{ and }\FractionalPart Γ > f\text, \\
\frac{k+f-\FractionalPart Γ}{3} & \text{otherwise.}
\end{cases}
\end{align*}
Accordingly, for the quick approximation $q$, we have, again up to at most $3$ half-units in the last place,\begin{align*}
q\approx q' &= \begin{cases}
1+\frac{f-\FractionalPart Γ}{6} & \text{if }k = 0\text{ and }\FractionalPart Γ > f\text, \\
1+\frac{k+f-\FractionalPart Γ}{3} & \text{otherwise,}
\end{cases}
\end{align*}
With $\cuberoot y = 2^{\frac{\Floor{Γ}+k}{3}}\cuberoot{1+f}$, we can define\[
ε' \DefineAs \frac{q'}{\cuberoot y}-1\text,
\]
which we can express piecewise as a function of $f$ and $k$. This gives us a bound on the relative error,\[
\abs ε \leq \abs{ε'}\pa{1+3u}\text.
\]
The values $Γ=0.1009678$ and $ε<3.2\%$ from \cite{KahanBindel2001} may be recovered by choosing $Γ$ minimizing the maximum of $\abs{ε'}$ over $y\in\intclop{η}{8η}$,
or equivalently.\begin{align*}
Γ_{\mathrm{Kahan}}\DefineAs\argmin_{Γ\in\R}\max_{y\in\intclop{η}{8η}}\abs{ε'}
&=\argmin_{Γ\in\R}\max_{\tuple{f, k}}\abs{ε'}\\
\intertext{where the maximum is taken over $\tuple{f, k}\in\intclop{0}{\FractionalPart Γ}\Cartesian\set{0}\Union\intclop{0}{1}\Cartesian\set{1,2}$,}
&=\argmin_{Γ\in\R}\max_{\tuple{f, k}\in\mathscr{E}\Union\mathscr{L}}\abs{ε'}\text,
\end{align*}
where $\mathscr{E}\DefineAs\set{\tuple{\FractionalPart Γ, 0}}\Union\setst{\tuple{0, k}}{k\in\set{0,1,2}}$ is the set of the endpoints of the intervals whereon $q'$ is piecewise affine, and
$\mathscr{L}\DefineAs\setst{\tuple{\frac{k-\FractionalPart Γ}{2},k}}{k\in\set{1,2}}$ are the local extrema.

The values are more precisely\footnote{These may be computed formally, but the expressions are unwieldy.}\begin{align*}
Γ_{\mathrm{Kahan}} &\approx 0.10096\,78121\,55802\,88786\,36993\,42643\,55358\,06489\,88235\,75289\\
\intertext{with}
\max_{y}\abs{ε'} &\approx 0.03155\,46327\,73624\,80606\,11789\,73328\,17135\,58940\,02093\,40816\text,
\end{align*}
leading to $C_{\mathrm{Kahan}}=\hex{2A9F\,7625\,3119\,D328}\Multiply 2^{-52}$ for IEEE 754-2008 binary64.
However, as we will see in the next section, this value does not optimize the final error, so it is not the one that we use.
\subsection{Getting to a third of the precision}
We use a single iteration of Lagny’s rational method to compute $ξ$,\[
ξ\DefineAs
\round{q - \round{\frac{\round{\pa{\round{\round{q^2}q}-y} q}}
                       {\round{2\round{\round{q^2}q}+y}}}}\text.
\]
Note that the subtraction in the numerator is exact by Sterbenz's lemma.

Let $Δ \DefineAs \frac{ξ}{\sqrt[3] y}-1$ and  % TODO(egg): Figure out why \cuberoot does not render here.
\[
ξ'=q'-\frac{\pa{{q'}^3-y}q'}{2{q'}^3+y}\text,
\]
so that, up to rounding errors,\[
Δ \approx Δ' \DefineAs \frac{ξ'}{\sqrt[3] y}-1\text.
\]

With $q'=\cuberoot{y}\pa{1+ε'}$, we can express $Δ'$ using the transformation of
the relative error error by one step of Lagny’s rational method on the cube root,\[
Δ' = \frac{2{ε'}^3+{ε'}^4}{3+6ε'+6{ε'}^2+2{ε'}^3}\text.
\]
If $q'$ is computed using $Γ=Γ_{\mathrm{Kahan}}$, we get\begin{align*}
\max_{y} \abs{Δ'} \approx 0.00002196\text,\\
\log_2 \max_{y} \abs{Δ'} \approx -15.47\text.
\end{align*}
However, $Γ_{\mathrm{Kahan}}$, which minimizes $\max_{y} \abs{ε}$, does not
minimize $\max_{y} \abs{Δ'}$. This is because while $Δ'$ is monotonic as a
function of $ε'$, it is not odd: positive errors are reduced more than negative
errors are, so that the minimum is attained for a different value of $Γ$.
Specifically, we have\begin{align*}
Γ_{\mathrm{L}}&\DefineAs\argmin_{Γ\in\R}\max_{y}\abs{Δ'}\\
&\approx 0.09918\,74615\,29855\,99525\,66149\,20761\,31234\,34720\,23067\,92759
\intertext{with}
\max_{y} \abs{ε'} &\approx 0.03103\,20521\,29929\,93577\,08166\,75859\,02139\,33719\,41389\,93269\text,
\intertext{but}
\max_{y} \abs{Δ'} &\approx 0.00002\,08686\,35536\,39593\,48770\,92008\,39844\,10254\,14831\,61229\text.
\end{align*}
The corresponding fixed-point constant is $C_{\mathrm{L}}\DefineAs\hex{2A9F\,7893\,782D\,A1CE} \Multiply 2^{-52}$ for binary64.
\marginpar{\small
TODO(egg): $Δ'$ accounts for half of the excess above correct rounding in the final bound; consider using either
a higher order iteration or Lagny's irrational formula. Also consider optimizing the constants in the method, as in
\cite{Canon2018}; in the rational method of order $3$ there are none to optimize.
% 9 Jul 2018
% https://twitter.com/stephentyrone/status/1016283784067665920
% A trick I’ve used for years and should write up: you can apply optimization to the iteration,
% not just the starting guess: x’ = x p(x), select p(x) to be minimax error on bounded initial
% error in x. This yields a nice family of tunable approximations.
% https://twitter.com/stephentyrone/status/1016284058438062081
% Everyone else seems to worry about starting estimate, but use standard iterations,
% which is appropriate for arbitrary precision, but silly with a fixed precision target.
% Note:
% Note that as p gets to be high-order, it converges quickly to the Taylor series for the
% correction, but there's a nice space with cheap initial approximations and order 2-5 or
% so, because we can evaluate these polynomials with lower latency then serially-dependent
% iterations.

}

\paragraph{Rounding error analysis.}
It is fairly clear that $Δ'$ dominates the rounding error in $Δ\approx Δ'$;
for the sake of completeness we quantify this.

Since we have a cancellation in the numerator, a little bit of care is
needed to bound those errors.
As mentioned above, $q$ approximates $q'$ to a relative error of at most $3u<γ_3$.
The sum in the denominator\[d\DefineAs\round{2\round{\round{q^2}q}+y}\]has positive terms,
so its relative error with respect to $d'\DefineAs2{q'}^3+y$ is readily bounded,\[
\frac{d}{d'}-1<γ_{3\Multiply3+3}=γ_{12}\text.
\]
The cancelling difference
$b\DefineAs\round{\round{q^2}q}-y$ differs from $b'\DefineAs{q'}^3-y$  by at most
\[δ\DefineAs{q'}^3γ_{3\Multiply3+2}={q'}^3γ_{11}\text,\]
and the numerator $\round{b q}$ from $b'q'$ by at most
\[\pa{\pa{b'+δ}q'\pa{1+γ_3}}\pa{1+γ}-b'q'=\pa{1+γ_4}δq'+γ_4b'q'\text.\]
We can bound the relative error of the correction term,
\begin{align*}
\abs{\frac{\round{\frac{\round{bq}}{d}}}{\frac{b'q'}{d'}}-1}<
\frac{\frac{b'q'+\pa{1+γ_4}δq'+γ_4b'q'}{d'\pa{1-γ_{12}}}}{\frac{b'q'}{d'}}-1
&=\frac{1+\frac{\pa{1+γ_4}δ}{b'}+γ_4}{\pa{1-γ_{12}}}-1\\
&=\frac{\pa{1+γ_4}δ}{\pa{1-γ_{12}}b'}+\frac{γ_4+γ_{12}}{\pa{1-γ_{12}}}\\
\end{align*}

\subsection{Rounded approximation}

The number $x$ is obtained from $ξ$ by zeroing all but the most significant $\Floor{\frac{p}{3}}$ bits of
its significand.
The resulting relative error\[\abs{\frac{x}{ξ}-1}\]is greatest when the zeroed bits are all $1$ and the
remaining bits (except for the leading $1$) are all $0$; this is the case when the significand of $ξ$ is
$1+2^{-\Floor{\frac{p}{3}}+1}-2^{1-p}$, in which case that of $x$ is $1$.

The relative error arising from $\FunctionBody ξ x$ is thus at most\[
1-\frac{1}{1+2^{-\Floor{\frac{p}{3}}+1}-2^{1-p}} < 2^{-\Floor{\frac{p}{3}}+1}\text,
\]
$2^{-16}$ in binary64.

\subsection{High order iteration}

We use one iteration of the Lagny--Schröder method of order $6$:\[
r\DefineAs\round{x-\round{\frac{
\round{\round{x\pa{x^3-y}}\round{\round{\round{\round{5x^3}+\round{17y}}x^3}+\round{5\round{y^2}}}}}{
\round{\round{\round{\round{7x^3} + \round{42 y}}\round{x^6}}+\round{\round{\round{30x^3}+2y}\round{y^2}}}}}}\text,
\]
Where $x^3$ is exact thanks to the trailing $0$s of $x$, $\round{x^6}$ is correctly-rounded because it is computed as
the square of $x^3$, and $x^3-y$ is exact by Sterbenz’s lemma.


\marginpar{\small
TODO(egg): consider order $5$; the truncation error is dominated by the rounding error here.}

\emergencystretch 1em
\end{document}
