\documentclass[10pt, a4paper, twoside]{basestyle}

\usepackage[backend=biber,firstinits=true,maxnames=100,style=alphabetic,maxalphanames=4,doi=true,isbn=false,url=false,eprint=true]{biblatex}
\bibliography{bibliography}

\usepackage[Mathematics]{semtex}
\usepackage{chngcntr}
\counterwithout{equation}{section}

%%%% Shorthands.
\DeclareMathOperator{\bias}{\mathit{bias}}
\newcommand{\round}[1]{\doubleSquareBrackets{#1}}
\newcommand{\roundToZero}[1]{\doubleSquareBrackets{#1}_0}
\newcommand{\hex}[1]{{_{16}}\symrm{#1}}

%%%% Title and authors.

\title{%
\textdisplay{%
A nearly correctly-rounded cube root%
}%
}
\author{Robin~Leroy (eggrobin)}
\begin{document}
\maketitle
\noindent
This document describes the error analysis of the real cube root function \texttt{Cbrt} implemented in \texttt{numerics/cbrt.cpp}.

\section*{Overview}
The general approach to compute the cube root of $y>0$ is the same as the one described in \cite{KahanBindel2001}:
\begin{enumerate}
\item integer arithmetic is used to get a an initial quick approximation $q$ of $\cuberoot y$;
\item a root finding method is used to improve that that to an approximation $ξ$ with a third of the precision;
\item $ξ$ is rounded to a third of the precision, resulting in the rounded approximation $x$ whose cube $x^3$ can be computed exactly;
\item a single high order iterate of a root finding method is used to get the final result.
\end{enumerate}

\section*{Notation}
We define the fractional part as $\FractionalPart a\DefineAs a-\Floor a\in\intclop{0}{1}$, regardless of the sign of $a$.

The quantities $p\in\N$ (precision in bits) and $\bias\in\N$ are as defined in IEEE 754-2008. 

We use capital letters fixed-point numbers involved in the computation, and $A>0$ for the normal floating-point number $a>0$ reinterpreted as a binary fixed-point number with $t$ bits after the binary point\footnote{The implementation uses integers (obtained by multiplying the fixed-point numbers by $2^{p-1}$). For consistency with \cite{KahanBindel2001} we work with fixed-point numbers here. Since we do not multiply fixed point numbers together, the expressions are unchanged.},\begin{align*}
  A &\DefineAs \bias + \Floor{\log_2 a} + \FractionalPart \pa{2^{-\Floor{\log_2 a}}a}\\
    &= \bias + \Floor{\log_2 a} + 2^{-\Floor{\log_2 a}}a - 1\text,\\
\intertext{and \emph{vice versa},}
  a &\DefineAs 2^{\Floor A-\bias} \pa{1+\FractionalPart{A}}\text.\\
\end{align*}
This corresponds to \cite{KahanBindel2001}'s $B+K+F$.

For both fixed- and floating-point numbers, given $α\in\R$, we write $\round{α}$ for the nearest representable number (rounding ties to even).
For fixed-point numbers, we write $\roundToZero{α}$ for directed rounding towards $0$ to the fixed-point precision (as in division implemented with integer division).

Except in the section on rescaling, the input $y$ and all intervening floating-point numbers are taken to be normal; the rescaling performed to avoid overflows also avoids subnormals.

\section{Quick approximation}
The quick approximation $q$ is computed using fixed-point arithmetic as\[
Q\DefineAs C + \roundToZero{\frac{Y}{3}}\text,
\]
where the fixed-point constant $C$ is defined as\footnote{Note
that there is a typo in the corresponding expression $C\DefineAs\pa{B-0.1009678}/3$ in \cite{KahanBindel2001}; a factor of $2$ is missing on the bias term.}\[
C\DefineAs \round{\frac{2\bias-γ}{3}}
\]
for some $γ\in\R$.

Let $ε \DefineAs \frac{q}{\sqrt[3] y}-1$,  % TODO(egg): Figure out why \cuberoot does not render here.
so that $\cuberoot y\pa{1+ε}=q$; the relative error of $q$ as an approximation of $\cuberoot y$ is $\abs ε$.
Considering $Y$, $Q$, $q$, and $ε$ as functions of $y$, we have\begin{align*}
Y\of{8y} &= Y\of{y} + 3\text,\\
Q\of{8y} &= Q\of{y} + 1\text,\\
q\of{8y} &= 2q\of{y}\text,\\
ε\of{8y} &= ε\of{y}\text,
\end{align*}
so that the properties of $ε$ need only be studied on some interval of the form $\intclop{η}{8η}$.

Pick $η\DefineAs2^{\Floor{γ}}$, and $y\in\intclop{η}{8η}=\intclop{2^{\Floor{γ}}}{2^{\Floor{γ}+3}}$,
so that $\log_2 y\in\intclop{\Floor{γ}}{\Floor{γ}+3}$. Let $k\DefineAs\Floor{\log_2 y}-\Floor{γ}$; note that $k\in\set{0,1,2}$.
Let $f\DefineAs\FractionalPart\pa{2^{-\Floor{\log_2 y}}y}\in\intclop{0}{1}$.
Up to at most $1.5$ units in the last place from rounding,\begin{align*}
Q\approx Q'\DefineAs&\bias+\frac{\Floor{\log_2 y}}{3}+\frac{\FractionalPart\pa{2^{-\Floor{\log_2 y}}y}-γ}{3}\text,\\
=&\bias+\frac{\Floor{γ}+k}{3}+\frac{f-γ}{3}\text,\\
=&\bias+\frac{k+f-\FractionalPart γ}{3}\text.
\end{align*}
Since $k\in\intclos{0}{2}$, the numerator $k+f-\FractionalPart γ$ lies in $\intopen{-1}{3}$.
Further, it is negative only if $k=0$, so that\begin{align*}
\Floor{Q'}&=\begin{cases}
\bias - 1 & \text{if }k = 0\text{ and }\FractionalPart γ > \FractionalPart\pa{2^{-\Floor{γ}}y}\text, \\
\bias & \text{otherwise,}
\end{cases}\text{ and}\\
\FractionalPart{Q'}&=\begin{cases}
1+\frac{f-\FractionalPart γ}{3} & \text{if }k = 0\text{ and }\FractionalPart γ > f\text, \\
\frac{k+f-\FractionalPart γ}{3} & \text{otherwise.}
\end{cases}
\end{align*}
Accordingly, for the quick approximation $q$, we have, again up to at most $1.5$ units in the last place,\begin{align*}
q\approx q' &= \begin{cases}
1+\frac{f-\FractionalPart γ}{6} & \text{if }k = 0\text{ and }\FractionalPart γ > f\text, \\
1+\frac{k+f-\FractionalPart γ}{3} & \text{otherwise,}
\end{cases}
\end{align*}
With $\cuberoot y = 2^{\frac{\Floor{γ}+k}{3}}\cuberoot{1+f}$, we can define\[
ε' \DefineAs \frac{q'}{\cuberoot y}-1\text,
\]
which we can express piecewise as a function of $f$ and $k$. This gives us a bound on the relative error,\[
\abs ε \leq \abs{ε'}+1.5 \Multiply 2^{p-1}\pa{1+\abs{ε'}}\text.
\]
The values $γ=0.1009678$ and $ε<3.2\%$ from \cite{KahanBindel2001} may be recovered by choosing $γ$ minimizing the maximum of $\abs{ε'}$ over $y\in\intclop{η}{8η}$,
or equivalently.\begin{align*}
γ_{\text{Kahan}}\DefineAs\argmin_{γ\in\R}\max_{y\in\intclop{η}{8η}}\abs{ε'}
&=\argmin_{γ\in\R}\max_{\tuple{f, k}}\abs{ε'}\\
\intertext{where the maximum is taken over $\tuple{f, k}\in\intclop{0}{\FractionalPart γ}\Cartesian\set{0}\Union\intclop{0}{1}\Cartesian\set{1,2}$,}
&=\argmin_{γ\in\R}\max_{\tuple{f, k}\in\mathscr{E}\Union\mathscr{L}}\abs{ε'}\text,
\end{align*}
where $\mathscr{E}\DefineAs\set{\tuple{\FractionalPart γ, 0}}\Union\setst{\tuple{0, k}}{k\in\set{0,1,2}}$ is the set of the endpoints of the intervals whereon $q'$ is piecewise affine, and
$\mathscr{L}\DefineAs\setst{\tuple{\frac{k-\FractionalPart γ}{2},k}}{k\in\set{1,2}}$ are the local extrema.

The values are more precisely\footnote{These may be computed formally, but the expressions are unwieldy.}\begin{align*}
γ_{\text{Kahan}} &\approx 0.10096\,78121\,55802\,88786\,36993\,42643\,55358\,06489\,88235\,75289\\
\intertext{with}
\max_{y}\abs{ε'} &\approx 0.03155\,46327\,73624\,80606\,11789\,73328\,17135\,58940\,02093\,40816\text,
\end{align*}
leading to $C_{\text{Kahan}}=\hex{2A9F\,7625\,3119\,D328}\Multiply 2^{-52}$ for IEEE 754-2008 binary64.
However, as we will see in the next section, this value does not optimize the final error, so it is not the one that we use.
\printbibliography
\end{document}
