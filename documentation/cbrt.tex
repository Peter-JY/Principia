\documentclass[10pt, a4paper, twoside]{basestyle}

\usepackage[Mathematics]{semtex}
\usepackage{chngcntr}

\counterwithout{equation}{section}
\renewcommand{\thesubsection}{\arabic{subsection}}

\setcounter{MaxMatrixCols}{20}

% REMOVE BEFORE FLIGHT: move to semtex.
\newlength{\medianToZeroTop}
\newcommand\zeroBL[1]{\multicolumn{1}{l}{\rlap{\smash{\text{{#1$0$}}}}}}
\newcommand\zeroBR[1]{\multicolumn{1}{r}{\llap{\smash{\text{{#1$0$}}}}}}
\newcommand\zeroTR[1]{\multicolumn{1}{r}{\llap{\smash{\setlength{\medianToZeroTop}{\heightof{#1$0$}-1ex}\raisebox{-\medianToZeroTop}{\text{{#1$0$}}}}}}}

% REMOVE BEFORE FLIGHT: move to basestyle.
\usepackage[all]{nowidow}

%%%% Shorthands.
\DeclareMathOperator{\bias}{\mathit{bias}}
% Rounding brackets will be heavily nested, and reading the nesting depth is critically important,
% so we make them grow for readability.
\newcommand{\round}[1]{\doubleSquareBrackets*{#1}}
\newcommand{\roundToZero}[1]{\doubleSquareBrackets{#1}_0}
\newcommand{\hex}[1]{{_{16}}\mathrm{#1}}

\newcommand{\bigradient}[4]{\det\begin{pmatrix}\pa{#1}_{#2}\\\pa{#3}_{#4}\end{pmatrix}}

%%%% Title and authors.

\title{A correctly rounded binary64 cube root}
\date{REMOVE BEFORE FLIGHT \printdate{2021-04-36}}
\author{Robin~Leroy (eggrobin)}
\begin{document}
\maketitle
\noindent
This document describes the computations in \href{https://github.com/mockingbirdnest/Principia/blob/master/numerics/cbrt.cpp}{\texttt{numerics/cbrt.cpp}}.

\section*{On some abridged root-finding methods}

We recall two families of root-finding methods from the late 17th century.

In \cite{FantetdeLagny1691a}, Thomas Fantet de~Lagny first presents the iterations\begin{align}
\FunctionBody*{a}{\tfrac{1}{2}a+\sqrt{\tfrac{1}{4}a^2+\frac{b}{3a}}}\text, \label{LagnyIrrationalCubeRootIteration}
\intertext{hereafter the \emph{(quadratic) irrational method}, and}
\FunctionBody*{a}{a+\frac{ab}{3a^3+b}}\text, \label{LagnyRationalCubeRootIteration}
\end{align}
the \emph{rational method}, for the computation of the cube root
$\cuberoot{a^3+b}$, mentioning the existence of similar methods for arbitrarily
higher powers.
In \cite{FantetdeLagny1691b} the above methods are again given, with an outline
of the general method for higher powers, and a mention of their applicability to
finding roots of polynomials other than $z^p-r$.

That general method is given in detail in \cite[19]{FantetdeLagny1692}.
Modernizing the notation, the general rule is as follows for finding a root of the monic
polynomial of degree $p\geq2$\[
f\of{z}\DefineAs z^p + c_1 z^{p-1} + \dotsb + c_{p-1} z + c_p \DefinitionOf z^p - R\of{z}
\]
with an initial approximation $a$.

Separate the binomial expansion of $\pa{x+\tfrac{1}{2}a}^p$ into alternating sums of
degree $p$ and $p-1$ in $z$,\begin{align*}
S_1\DefineAs\sum{\substack{k=0\\2\Divides k}}[p]\binom{p}{k}x^{p-k}\pa{\tfrac{1}{2}a}^k&\text{ and }
S_2\DefineAs\sum{\substack{k=0\\2\DoesNotDivide k}}[p]\binom{p}{k}x^{p-k}\pa{\tfrac{1}{2}a}^k\text,
\intertext{and consider the following polynomials, of degree $p$ and $p-1$ in $x$ for almost all $a$:}
E_{p}\DefineAs S_1-\tfrac{1}{2}R\of{x+\tfrac{1}{2}a}&\text{ and }
E_{p-1}\DefineAs S_2-\tfrac{1}{2}R\of{x+\tfrac{1}{2}a}\text.
\end{align*}
Let $E_{n-1}$ be the remainder of the polynomial
division\footnote{While the rest of the method is a straightforward translation, this step bears some explanations; its description in \cite{FantetdeLagny1692} is
% TODO(egg): Right Single Quotation Mark leads to incorrect spacing in French, so we use Apostrophe here (which
% gets converted to Right Single Quotation Mark by the typesetting engine).  Figure out what is going on.
\begin{quote}\textfrench{De ces deux égalitez, ou priſes ſéparément, ou comparées enſemble ſelon la methode des problêmes plus que déterminez tirez en une valeur d'$x$ rationelle, ou ſimplement d'un degré commode.}
\end{quote}
It is assumed that the reader is familiar with this ``comparison according to the method of
more-than-determined problems''.
While the application of the root-finding method is described in painstaking detail in \cite{FantetdeLagny1733},
which outlines the treatment of overdetermined problems, it is perhaps this remark from \cite[494]{FantetdeLagny1697} which lays it out most clearly:
\begin{quote}\textfrench{Il n'y a rien de nouveau à remarquer ſur les Problemes plus que déterminez du quatriéme degré. La Regle générale eſt d'égaler tout à zero, \& de diviſer la plus haute équation par la moins élevée, ou l'également élevée l'une par l'autre, continuellement juſques à ce que l'on trouve le reſte ou le diviſeur le plus ſimple.}
\end{quote}}
of $E_{n+1}$ by $E_{n}$; its degree is $n-1$ for almost all $a$.
The iteration is $\FunctionBody{a}{x+\frac{1}{2}a}$, where $x$ is a root of $E_{2}$ in the quadratic irrational method,
and the root of $E_{1}$ in the rational method. Its order is $p$.

\subsection*{Names and multiplicity of the irrational methods}
Lagny does not require that the polynomial division be carried out
all the way to $E_2$, merely until one gets \foreign{\textfrench{une valeur d'$x$ \textnormal{[...]} d'un degré commode}}, by which he likely means
one that is constructible. When $f$ is a cubic, he uses the term \foreign{\textfrench{formule irrationnelle}} for $x+\frac{1}{2}a$ where
$x$ is a root of $E_2$, but when it comes to computing the fifth root, the same term is used to refer to the case where $x$ is a root of
$E_4$. In order to avoid confusion, we use the term \emph{quadratic irrational method} when $x$ is a root of $E_2$ in the general case,
and we call the irrational formula for $\sqrt[5]{a^5+b}$ from \cite[43]{FantetdeLagny1692}\footnote{The formula has a misprint in
\cite[43]{FantetdeLagny1692}, $-\tfrac{1}{2}a^2$ instead of $-\tfrac{1}{4}a^2$ under the radical.
Halley remarks on it and gives the corrected formula in \cite[137,140]{Halley1694}.
The misprint remains forty years later in \cite[\pno~440 misnumbered 340]{FantetdeLagny1733}.
Bateman writes in \cite{Bateman1938} ``we must not infer that [these expressions] are not correct simply because
they differ from Halley's expression'', but with Lagny's construction, which was seemingly unknown to Bateman, the
error is plain.}\[
\FunctionBody{a}{\tfrac{1}{2}a+\sqrt{\sqrt{\tfrac{1}{4}a^4+\tfrac{b}{5a}}-\tfrac{1}{4}a^2}}
\]
Lagny's \emph{quartic irrational method} for the fifth root;
the quadratic irrational method for the same fifth root would be\footnote{Both are of order $5$, but the reader who wishes
to compute a fifth root should note that leading term of the error of the quartic method is
$\frac{2}{7}$ of that of the quadratic.}\[
\FunctionBody{a}{\frac{a\pa{7b-\sqrt{100a^{10}+100a^{5}b-7b^2}}}{4b-10a^5}}\text.
\]
Note that for the computation of the cube root, the phrase \emph{Lagny's irrational method} is unambiguous;
assuming that one does not wish to reduce the computation of a cube root to that of of the root the cubic $E_3$,
the only irrational method is the quadratic (\ref{LagnyIrrationalCubeRootIteration}).

Halley generalized\footnote{Lagny's method is general, in that an iteration is given for any
polynomial, albeit one whose order changes with the degree. However, while he refers to its
results---and even corrects a misprint therein---, Halley
did not have access to a copy of \cite{FantetdeLagny1692},
\begin{quote}
Has Regulas, cum nondum librum videram, ab amico communicatas habui
\end{quote}
and it appears that said friend communicated only the formulæ for the cube and fifth root, as opposed to the
general method and its proof, as Halley writes
\begin{quote}
[...] \emph{D. de Lagney} [...] qui cum totus fere ſit in eliciendis Poteſtatum purarum radicibus,
præfertim Cubicâ, pauca tantum eaque perplexa nec ſatis demonſtrata de affectarum radicum
extractione ſubjungit.
\end{quote}
or, about the quartic irrational method for the fifth root, whereon Lagny does not elaborate as
it is a direct application of the general method,
\begin{quote}
Author autem nullibi inveniendi methodum ejuſve demonſtrationem concedit,
etiamſi maxime deſiderari videatur [...].
\end{quote}
Being unaware of this generality, Halley sets out to generalize (\ref{LagnyIrrationalCubeRootIteration}) and (\ref{LagnyRationalCubeRootIteration}) to
arbitrary polynomials, and does so by keeping the order constant.}
the quadratic irrational method for $p=3$ to arbitrary polynomials, retaining cubic convergence; when $f$ is
not a polynomial of degree $3$, we call the resulting iteration \emph{Halley's irrational method}.
This method was given in terms of derivatives by Bateman in \cite[12]{Bateman1938}:\[
\FunctionBody{a}{a-\frac{f'\of{a}}}{f''\of{a}}+\frac{\sqrt{{f'}^2\of{a}-2f\of{a}f''\of{a}}}{f''\of{a}}\text.
\]

\subsection*{Names of the rational method}
As for Halley's irrational method, modern calculus allows us to give a more straightfoward expression
for the rational method than was available to Lagny;
the proof of the following equivalence will be given at the end of this section.

\begin{proposition}
The iteration of Lagny’s rational method for a monic polynomial $f$ of degree $p$ is\begin{equation}
a\mapsto a + \pa{p-1}\frac{\pa{1/f}^{\pa{p-2}}\of{a}}{\pa{1/f}^{\pa{p-1}}\of{a}}\text.\label{LagnyRationaliteration}
\end{equation}
\end{proposition}
The iteration (\ref{LagnyRationaliteration}) is a special case of the \foreign{Algorithmen $\pa{A^λ_ω}$} defined by Schröder for an
arbitrary polynomial $f$ in \cite[349\psq]{Schröder1870}, equation (69); specifically, it is $\pa{A^0_{p-1}}$.
As seen in the proof of the proposition, it is also a special case of Householder’s  equation (14) from \cite[169]{Householder1970},
which generalizes it by substituting $f/g$ for $f$, and letting $f$ be an arbitrary analytic function. The case
$g\Identically1$ is mentioned in theorem 4.4.2, and that expression is given explicitly in \cite{SebahGourdon2001}.

For $p=2$ and $f$ an arbitrary polynomial, (\ref{LagnyRationaliteration}) is Newton's method, presented by Wallis in
\cite[338]{Wallis1685}.

For $p=3$ and $f$ an arbitrary polynomial, it is Halley's rational method, given in \cite[142--143]{Halley1694} in
an effort to generalize Lagny's (\ref{LagnyRationalCubeRootIteration}).
It is usually simply known as Halley's method, as the irrational method---which likewise generalizes Lagny's irrational
method for $p=3$ while retaining constant order as the degree changes---has comparatively fallen into obscurity;
see \cite{ScavoThoo1995}.

Considering, as remarked by \cite[334]{Schröder1870}, that a method can often
be generalized from arbitrary polynomials or rational functions to arbitrary
analytic functions, we call the iteration (\ref{LagnyRationaliteration})\begin{itemize}[nosep]
\item Newton’s method when $p=2$, for arbitrary $f$;
\item Lagny’s rational method when $p>2$ and $f$ is a polynomial of degree $p$;
\item Halley’s rational method when $p=3$ and $f$ is not a polynomial of degree $3$;
\item the Lagny--Schröder rational method of order $p$ otherwise.
\end{itemize}
We do not simply call this last case ``Schröder’s method'', as it is only a special case of the methods
defined in \cite{Schröder1870}, so that the expression would be ambiguous. 

Note that we avoid the name ``Householder’s method'' which appears in \cite{SebahGourdon2001} and ulterior works (notably \emph{MathWorld} and \emph{Wikipedia}, both citing
\cite{SebahGourdon2001}), as it
is variably used to refer to either (\ref{LagnyRationaliteration}) or to a method from a different family, namely $\gj_{p+1}$
from \cite[168]{Householder1970}, equation (7), taking $γ_{p+1}\Identically0$ in the resulting iteration;
$\gj_3$ is\footnote{We are grateful to Peter Barfuss for this observation.} the iteration given in section 3.0.3
of \cite{SebahGourdon2001}. As mentioned by Householder, both of those were described by Schröder a century prior
anyway: Householder’s (7) is Schröder’s (18) from
\cite[327]{Schröder1870}.

\subsection*{Bibliographic note}
Our foray into the history of these methods was prompted by finding the ``historical background'' section of
\cite{ScavoThoo1995} while looking for a reference for Halley’s method: it is mentioned therein that this
method, as applied to the cube root, is due to Lagny.

Searching for Lagny’s work led us to the historical note \cite{Cantor1861}, wherein a note by the editors Terquem and Gerono reads
\begin{quote}\textfrench{%
Naturellement, en mathématiques, séjour des propositions irréfragables, identiques en toute langue, en tout pays, ces rencontres ne peuvent manquer d'être assez fréquentes; nulle part les plagiats \emph{effectifs} sont si rares, et les plagiats \emph{apparents} si communs que dans la science exacte par excellence; mais les signaler est un devoir, un service rendu à l'histoire scientifique.}
\end{quote}
The editors then quote a letter by Prouhet, wherein he gives a reference to \cite{FantetdeLagny1692}.

Lagny’s work proved far more extensive than we expected: besides the above root finding methods for arbitrary
polynomials, it contains an error analysis, and even a discussion of the principles of performance analysis based on a decomposition into elementary operations on---and
writing of---decimal digits: a 17th century MIX.

Observing that the higher-order examples correspond to the well-known higher order
method attributed to Householder in \cite{SebahGourdon2001}, we looked for its properties in \cite{Householder1970} so as to prove that observation, and found that Householder attributes
them to Schröder.
As mentioned in the translator’s note by Stewart in \cite{SchröderStewart1993},
\begin{quote}
A.~S.~Householder used to claim you could evaluate a paper on
root finding by looking for a citation of Schröder’s paper. If it was
missing, the author had probably rediscovered something already
known to Schröder.
\end{quote}
It is possible that the irrational methods could be expressed using Schröder’s methods in one way or another, but while
the result would probably be more convenient, it is unlikely to be something well-known, as irrational methods are far less
popular nowadays---unjustifiedly so, as we shall see.

It may however be useful to generalize the irrational methods as Halley did in the case $p=3$, untying their order from
the degree of the polynomial---or indeed from the polynomial nature of $f$.
This should yield a two-parameter family of root finding methods for an analytical $f$, depending on the convergence
order and the degree of the equation solved by the iteration.
We have not been able to find such a generalization.

Prouhet’s letter in \cite{Cantor1861} ends with these words:
\begin{quote}\textfrench{%
Tout cela est fort abrégé; mais qui nous délivrera des méthodes abrégées,
qui n'en finissent pas?}\end{quote}

\subsection*{Proof of the proposition}

We now prove the above proposition, which, substituting the definition of Lagny’s rational method, is that
\[x+\tfrac{1}{2}a = a + \pa{p-1}\frac{\pa{1/f}^{\pa{p-2}}\of{a}}{\pa{1/f}^{\pa{p-1}}\of{a}}\DefinitionOf ψ\of{a}\]
if $x$ is the root of $E_1$.

\begin{proof}
Let $E_p = d_0 x^p + \dotsb + d_p$, $E_{p-1} = e_0 x^{p-1} + \dotsb + e_{p-1}$.
As shown in \cite[52--54]{Householder1970}, the polynomial remainders $E_k$ are given up to a constant factor by
\cite[19]{Householder1970} equation (23), \idest, for some $α$,\[
\frac{E_k}{α_k} = \bigradient{E_p}{p-1-k}{E_{p-1}}{p-k}\text,
\]
where the expression on the right-hand side is the \emph{bigradient} defined in \cite{Householder1968} (3.2)
or \cite[19]{Householder1970} (20),\[
\frac{E_k}{α_k} = \det\begin{pmatrix}
d_0    & d_1    & d_2 & \multicolumn{3}{c}{\cdots} & d_{2\pa{p-k}-3} & x^{p-k-2} E_p \\
       & d_0    & d_1 & \multicolumn{3}{c}{\cdots} & d_{2\pa{p-k}-4} & x^{p-k-3} E_p \\
       &        & \ddots  &      &                 &                 & \vdots \\
       &        &         & d_0  & d_1 & \cdots    & d_{p-k-1}       & x^{0} E_p \\
\zeroBL\huge&   &         &      & e_0 & \cdots    & e_{p-k-2}       & x^{0} E_{p-1} \\
       &        &         &\adots&     &           &                 & \vdots \\
       &        & e_0 & \multicolumn{3}{c}{\cdots} & e_{2\pa{p-k}-4} & x^{p-k-2} E_p \\
       & e_0    & e_1 & \multicolumn{3}{c}{\cdots} & e_{2\pa{p-k}-4} & x^{p-k-2} E_p \\
e_0    & e_1    & e_2 & \multicolumn{3}{c}{\cdots} & e_{2\pa{p-k}-3} & x^{p-k-1} E_p \\
\end{pmatrix}\DefinitionOf\det\matE_k\text,
\]
where $d_n\DefineAs0$ for $n>p$, and $e_n\DefineAs0$ for $n>p-1$.

In particular, for $k=1$,\[
\matE_1=\begin{pmatrix}
d_0    & d_1    & d_2    & \cdots & d_{p-3} & d_{p-2} & d_{p-1} & d_p     &      &\zeroTR\huge& x^{p-3} E_p     \\
       & d_0    & d_1    & \cdots & d_{p-4} & d_{p-3} & d_{p-2} & d_{p-1} & d_p     &         & x^{p-4} E_p     \\[1ex]
       &        & \ddots &        &         &         &         &         &         & \ddots  & \vdots          \\[1ex]
       &        &        & d_0    & d_1     & d_2     & \multicolumn{3}{c}{\cdots}  & d_{p-2} & x^{0} E_p       \\
\zeroBL\huge&   &        &        & e_0     & e_1     & \multicolumn{3}{c}{\cdots}  & e_{p-3} & x^{0} E_{p-1}   \\[1ex]
       &        &        & \adots &         &         &         &         &         & \adots  & \vdots          \\[1ex]
       &        & e_0    & \cdots & e_{p-5} & e_{p-4} & e_{p-3} & e_{p-2} & e_{p-1} &         & x^{p-5} E_{p-1} \\
       & e_0    & e_1    & \cdots & e_{p-4} & e_{p-3} & e_{p-2} & e_{p-1} &         &         & x^{p-4} E_{p-1} \\
e_0    & e_1    & e_2    & \cdots & e_{p-3} & e_{p-2} & e_{p-1} &         &      &\zeroBR\huge& x^{p-3} E_{p-1} \\
\end{pmatrix}\text.
\]
Observe that, since the value of $x$ used in the rational method is the root of $E_1$, for that value of $x$,
$\det \matE_1 = 0$, \idest, $\matE_1$ is singular.
\begin{lemma}
The matrix $\matE_1$ is singular if and only if $\matC\of{x+\frac{1}{2}a}$ is singular, where\[
\matC\of{Ψ}\DefineAs\begin{pmatrix}
Ψ - a  & c_0     &&&\zeroTR\huge\\
-1     & c_1     & c_0 \\
0      & c_2     &        & \ddots \\
\vdots & \vdots  & \ddots &        & c_0 \\
0      & c_{p-1} & \cdots & c_2    & c_1
\end{pmatrix}
\] and $c_0\DefineAs1$.\marginpar{TODO(egg): Prove the lemma.}
\begin{proof}[Left as an exercise to the reviewer]
Observe that:\begin{itemize}
\item since $\det \matE_1$ is a polynomial of degree $1$, all terms divisible by $x^2$ must cancel out in the Laplace expansion of that
determinant on the last column, the determinant is equal to\[
\pm δ_1 xE_p \mp δ_2 E_p \pm δ_3 E_{p-1} \mp δ_4 xE_{p-1}\text,
\]
where the $δ_i$ are determinants of real matrices;
\item by the same reasoning, only the linear and constant terms of the polynomials remain in the above expression, which simplifies to\[
\pm δ_1 d_p x \mp δ_2 \pa{d_{p-1}x + d_p} \pm δ_3 \pa{e_{p-2}x + e_{p-1}} \mp δ_4 e_{p-1}x\text;
\]
\item $E_p-E_{p-1}=S_1-S_2$, which, by Lagny’s \foreign{\textfrench{theoreme fondamental}}
\cite[17]{FantetdeLagny1692}, is $\pa{x-\frac{1}{2}a}^p$.
\end{itemize}
The proof is a calculation.
\end{proof}
\end{lemma}
The proposition follows from the lemma and theorem 4.4.2 from \cite[169]{Householder1970}:
$ψ\of{a}$ is Householder’s (14) with $g\Identically 1$; for that
value of $g$, theorem 4.4.2 states that (14) is the solution of (12) from the same page, which is
$\det\matC\of{ψ\of{a}}=0$.
By the lemma, for the value of $x$ in Lagny’s rational method, $x+\frac{1}{2}a$ solves that equation.
\end{proof}

\section*{A faithfully rounded cube root}

We now turn to the computation in \texttt{numerics/cbrt.cpp}.

\subsection*{Overview}
Our general approach to computing a faithfully rounded cube root of $y>0$ is the one described in \cite{KahanBindel2001}:
\begin{enumerate}
\item integer arithmetic is used to get a an initial quick approximation $q$ of $\cuberoot y$;
\item a root finding method is used to improve that that to an approximation $ξ$ with a third of the precision;
\item $ξ$ is rounded to a third of the precision, resulting in the rounded approximation $x$ whose cube $x^3$ can be computed exactly;
\item a single high order iteration of a root finding method is used to get the faithfully rounded result $r_0$.
\end{enumerate}

\subsection*{Notation}
We define the fractional part as $\FractionalPart a\DefineAs a-\Floor a\in\intclop{0}{1}$, regardless of the sign of $a$.

The floating-point format used throughout is binary64; the quantities $p\in\N$ (precision in bits) and $\bias\in\N$ are 
defined as in IEEE 754-2008, $p=53$ and $\bias=1023$.
Some of the individual methods discussed may be of general use; we thus give all constants to thirty-six decimal
digits\footnote{The constants used in the methods are rounded to the nearest decimal digit. A superscript sign after
a final $5$ serves as the sticky bit: the unrounded quantity is in excess of the rounded one if the sign is $+$,
and in default if it is $-$. The error bounds (and their logarithms) are rounded towards positive infinity.},
which should suffice for decimal128, binary128, and all smaller formats.

We use capital Latin letters for fixed-point numbers involved in the computation, and $A>0$ for the normal floating-point number $a>0$ reinterpreted as a binary fixed-point\footnote{The implementation uses integers (obtained by multiplying the fixed-point numbers by $2^{p-1}$). For consistency with \cite{KahanBindel2001} we work with fixed-point numbers here. Since we do not multiply fixed point numbers together, the expressions are unchanged.} number with $p-1$ bits after the binary point,\begin{align*}
  A &\DefineAs \bias + \Floor{\log_2 a} + \FractionalPart \pa{2^{-\Floor{\log_2 a}}a}\\
    &= \bias + \Floor{\log_2 a} + 2^{-\Floor{\log_2 a}}a - 1\text,\\
\intertext{and \emph{vice versa},}
  a &\DefineAs 2^{\Floor A-\bias} \pa{1+\FractionalPart{A}}\text.\\
\end{align*}
This corresponds to \cite{KahanBindel2001}'s $B+K+F$.

For both fixed- and floating-point numbers, given $α\in\R$, we write $\round{α}$ for the nearest representable
number (rounding ties to even).
For fixed-point numbers, we write $\roundToZero{α}$ for directed rounding towards $0$ to the fixed-point
precision (as in division implemented with integer division).
We write the unit roundoff $u\DefineAs2^{-p}$, and, after \cite[63]{Higham2002}, $γ_n\DefineAs\frac{nu}{1-nu}$.
We discuss other rounding modes in appendix~\ref{OtherRoundingModes}.

To quote \cite{Trefethen1997}, ``If rounding errors vanished, 95\% of numerical analysis would remain''.
While we keep track of rounding errors throughout, they are of very little importance until the last step;
when it is convenient to solely study the truncation error, we work with ideal quantities affected with a
prime, which correspond to their primeless counterparts by removal of all intervening roundings.

The input $y$ and all intervening floating-point numbers are taken to be normal; the rescaling performed
to avoid overflows also avoids subnormals. We work only with correctly rounded addition, subtraction,
multiplication, division, and square root; FMA is treated separately in appendix~\ref{FMA}.

\subsection{Quick approximation}
The quick approximation $q$ is computed using fixed-point arithmetic as\[
Q\DefineAs C + \roundToZero{\frac{Y}{3}}\text,
\]
where the fixed-point constant $C$ is defined as\footnote{Note
that there is a typo in the corresponding expression $C\DefineAs\pa{B-0.1009678}/3$ in \cite{KahanBindel2001}; a factor of $2$ is missing on the bias term.}\[
C\DefineAs \round{\frac{2\bias-Γ}{3}}
\]
for some $Γ\in\R$.

Let $ε_q \DefineAs \frac{q}{\sqrt[3] y}-1$,  % TODO(egg): Figure out why \cuberoot does not render here.
so that $\cuberoot y\pa{1+ε_q}=q$; the relative error of $q$ as an approximation of $\cuberoot y$ is $\abs{ε_q}$.
Considering $Y$, $Q$, $q$, and $ε_q$ as functions of $y$, we have\begin{align*}
Y\of{8y} &= Y\of{y} + 3\text,\\
Q\of{8y} &= Q\of{y} + 1\text,\\
q\of{8y} &= 2q\of{y}\text,\\
ε_q\of{8y} &= ε_q\of{y}\text,
\end{align*}
so that the properties of $ε_q$ need only be studied on some interval of the form $\intclop{η}{8η}$.

Pick $η\DefineAs2^{\Floor{Γ}}$, and $y\in\intclop{η}{8η}=\intclop{2^{\Floor{Γ}}}{2^{\Floor{Γ}+3}}$,
so that $\log_2 y\in\intclop{\Floor{Γ}}{\Floor{Γ}+3}$. Let $k\DefineAs\Floor{\log_2 y}-\Floor{Γ}$; note that $k\in\set{0,1,2}$.
Let $f\DefineAs\FractionalPart\pa{2^{-\Floor{\log_2 y}}y}\in\intclop{0}{1}$.
Up to at most $3$ half-units in the last place from rounding ($2$ from the directed rounding of the division
by three and $1$ from the definition of $C$), we have\begin{align*}
Q\approx Q'\DefineAs&\bias+\frac{\Floor{\log_2 y}}{3}+\frac{\FractionalPart\pa{2^{-\Floor{\log_2 y}}y}-Γ}{3}\text,\\
=&\bias+\frac{\Floor{Γ}+k}{3}+\frac{f-Γ}{3}\text,\\
=&\bias+\frac{k+f-\FractionalPart Γ}{3}\text.
\end{align*}
Since $k\in\intclos{0}{2}$, the numerator $k+f-\FractionalPart Γ$ lies in $\intopen{-1}{3}$.
Further, it is negative only if $k=0$, so that\begin{align*}
\Floor{Q'}&=\begin{cases}
\bias - 1 & \text{if }k = 0\text{ and }\FractionalPart Γ > \FractionalPart\pa{2^{-\Floor{Γ}}y}\text, \\
\bias & \text{otherwise,}
\end{cases}\text{ and}\\
\FractionalPart{Q'}&=\begin{cases}
1+\frac{f-\FractionalPart Γ}{3} & \text{if }k = 0\text{ and }\FractionalPart Γ > f\text, \\
\frac{k+f-\FractionalPart Γ}{3} & \text{otherwise.}
\end{cases}
\end{align*}
Accordingly, for the quick approximation $q$, we have, again up to at most $3$ half-units in the last place,\begin{align*}
q\approx q' &= \begin{cases}
1+\frac{f-\FractionalPart Γ}{6} & \text{if }k = 0\text{ and }\FractionalPart Γ > f\text, \\
1+\frac{k+f-\FractionalPart Γ}{3} & \text{otherwise,}
\end{cases}
\end{align*}
With $\cuberoot y = 2^{\frac{\Floor{Γ}+k}{3}}\cuberoot{1+f}$, we can define\[
ε_q' \DefineAs \frac{q'}{\cuberoot y}-1\text,
\]
which we can express piecewise as a function of $f$ and $k$. This gives us a bound on the relative error,\[
\abs ε_q \leq \abs{ε_q'}\pa{1+3u}\text.
\]
The values $Γ=0.1009678$ and $ε_q<3.2\%$ from \cite{KahanBindel2001} may be recovered by choosing $Γ$ minimizing the maximum of $\abs{ε_q'}$ over $y\in\intclop{η}{8η}$,
or equivalently.\begin{align*}
Γ_{\mathrm{Kahan}}\DefineAs\argmin_{Γ\in\R}\max_{y\in\intclop{η}{8η}}\abs{ε_q'}
&=\argmin_{Γ\in\R}\max_{\tuple{f, k}}\abs{ε_q'}\\
\intertext{where the maximum is taken over $\tuple{f, k}\in\intclop{0}{\FractionalPart Γ}\Cartesian\set{0}\Union\intclop{0}{1}\Cartesian\set{1,2}$,}
&=\argmin_{Γ\in\R}\max_{\tuple{f, k}\in\mathscr{E}\Union\mathscr{L}}\abs{ε_q'}\text,
\end{align*}
where $\mathscr{E}\DefineAs\set{\tuple{\FractionalPart Γ, 0}}\Union\setst{\tuple{0, k}}{k\in\set{0,1,2}}$ is the set of the endpoints of the intervals whereon $q'$ is piecewise affine, and
$\mathscr{L}\DefineAs\setst{\tuple{\frac{k-\FractionalPart Γ}{2},k}}{k\in\set{1,2}}$ are the local extrema. We get more precisely\footnote{This value may be computed formally, but the expression is unwieldy.}\[
Γ_{\mathrm{Kahan}} \approx 0.10096\,78121\,55802\,88786\,36993\,42643\,55358\,1\]
with $\max_{y}\abs{ε_q'} \approx 3.155\%$,
yielding the constant\[C_{\mathrm{Kahan}}=\hex{2A9F\,7625\,3119\,D328}\Multiply 2^{-52}\]for IEEE 754-2008 binary64.
However, as we will see in the next section, this value does not optimize the final error.
\subsection{Getting to a third of the precision}
We now consider multiple methods for the refinement of $q$ to $ξ$.
The rounding error in this step being both negligible and tedious to bound,
its analysis is relegated to appendix~\ref{LagnyStepTwoRounding}. Here we
will study only the truncation error, and thus work only with the primed quantities.

\subsubsection*{Lagny's rational method}
One way to compute $ξ'$ is Lagny's rational method,
\[
ξ'=q'+\frac{q'\pa{y-{q'}^3}}{2{q'}^3+y}\text,
\]
with the error\[
ε_ξ' \DefineAs \frac{ξ'}{\sqrt[3] y}-1\text.
\]

With $q'=\cuberoot{y}\pa{1+ε_q'}$, we can express $ε_ξ'$ using the transformation of
the relative error error by one step of Lagny’s rational method on the cube root,\[
ε_ξ' = \frac{2{ε_q'}^3+{ε_q'}^4}{3+6ε_q'+6{ε_q'}^2+2{ε_q'}^3}
= \tfrac{2}{3}{ε_q'}^3 + \BigO\of{{ε_q'}^4}\text.
\]
If $q'$ is computed using $Γ=Γ_{\mathrm{Kahan}}$, we get
$\max_{y} \abs{ε_ξ'} \approx 21.96\Multiply10^{-6}$, $\log_2 \max_{y} \abs{ε_ξ'} \approx -15.47$.
However, $Γ_{\mathrm{Kahan}}$, which minimizes $\max_{y} \abs{ε_q}$, does not
minimize $\max_{y} \abs{ε_ξ'}$. This is because while $ε_ξ'$ is monotonic as a
function of $ε_q'$, it is not odd: positive errors are reduced more than negative
errors are, so that the minimum is attained for a different value of $Γ$.
Specifically, we have\begin{align*}
Γ_{\mathrm{L^1}}&\DefineAs\argmin_{Γ\in\R}\max_{y}\abs{ε_ξ'}\\
&\approx 0.09918\,74615\,29855\,99525\,66149\,20761\,31234\,35^{-}
\end{align*}
with $\max_{y} \abs{ε_q'} \approx 3.2025\%$, but
$\max_{y} \abs{ε_ξ'} \approx 20.86\Multiply10^{-6}$, $\log_2 \max_{y} \abs{ε_ξ'} \approx -15.54$.
The corresponding fixed-point constant is\[C_{\mathrm{L^1}}\DefineAs\hex{2A9F\,7893\,782D\,A1CE} \Multiply 2^{-52}\]for binary64.

While it is close to the $16$ bits to which we will round in the next step, this error is
still larger, and in any case is not comparatively negligible. As a result, it significantly contributes to the final error above $1u$, \idest, to misrounding.
Lagny's lesser-known irrational method provides us with a way to improve it.
\subsubsection*{Lagny's irrational method}
As written in (\ref{LagnyIrrationalCubeRootIteration}), Lagny's irrational method
\[ξ' = \tfrac{1}{2}q'+\sqrt{\tfrac{1}{4}{q'}^2+\frac{y-{q'}^3}{3q'}}\]
seems prohibitively computationally expensive in comparison to the rational one: it adds a
square root on the critical path, dependent on the result of a division.
However, rewriting it as\begin{equation}
ξ' = \tfrac{1}{2}q'+ \frac{1/\sqrt{12}}{q'}\sqrt{4yq'-{q'}^4}\text,\label{RewrittenLagnyIrrational}
\end{equation}
one can evaluate it with similar\footnote{We compare specific evaluations strategies
for various architetures in appendix~\ref{LagnyIrrationalPerformance}; on some of those, other rewritings are superior
to this one.} performance to the rational method.

Its error is\[
ε_ξ' = \frac{-{ε_q'}^3}{3\pa{\tfrac{1}{2}+\sqrt{\tfrac{1}{2}-2{ε_q'}^2-\tfrac{4}{3}{ε_q'}^3-\tfrac{1}{3}{ε_q'}^4}- {ε_q'}^2}} =
-\tfrac{1}{3}{ε_q'}^3 + \BigO\of{{ε_q'}^4}\text,
\]
whose leading term is half that of the rational method; indeed we find that with $Γ=Γ_{\mathrm{Kahan}}$,
we have $\max_{y} \abs{ε_ξ'} \approx 10.48\Multiply10^{-6}$, $\log_2 \max_{y} \abs{ε_ξ'} \approx -16.54$, gaining one bit
with respect to the rational method.
Here $Γ=Γ_{\mathrm{Kahan}}$ is very close to optimal; with the optimal value\[
Γ_{\mathrm{L^2}}\approx0.10096\,82076\,65096\,37285\,40885\,52460\,33434\,6\text,
\]
the error remains the same within the precision to which we have given it.
However, we have other ways of improving the error at no cost to performance.
\subsubsection*{Canon optimization of Lagny's irrational method}
The idea for this optimization comes from \cite{Canon2018a}, reproduced here with the author’s permission:
\begin{quotation}
 % https://twitter.com/stephentyrone/status/1016283784067665920
 A trick I’ve used for years and should write up: you can apply optimization to the iteration,
 not just the starting guess: $x' = x p\of x$, select $p\of x$ to be minimax error on bounded
 initial error in $x$. This yields a nice family of tunable approximations.

 % https://twitter.com/stephentyrone/status/1016284058438062081
 Everyone else seems to worry about starting estimate, but use standard iterations,
 which is appropriate for arbitrary precision, but silly with a fixed precision target.

 % https://twitter.com/stephentyrone/status/1016328842296864770
 Note that as $p$ gets to be high-order, it converges quickly to the Taylor series for the
 correction, but there's a nice space with cheap initial approximations and order $2$--$5$ or
 so, because we can evaluate these polynomials with lower latency [than] serially-dependent
 iterations.
\end{quotation}
Canon later elaborated on this in \cite{Canon2018b}:
\begin{quotation}
 % https://twitter.com/stephentyrone/status/1057788315699687424
 Quick version: we want to compute $1/\sqrt{y}$, we have an approximation $x_0$, we want to
 improve it to $x_1 = x_0 p\of{x_0, y}$. For efficiency, we want $p$ to be a polynomial correction.\\
 \textit{handwavy motivation for brevity} make $p$ a polynomial in $x_0x_0y$, which is approximately $1$.

 % https://twitter.com/stephentyrone/status/1057789050810232834
 Specifically, if $x_0$ has relative error $e$, $x_0x_0y$ is bounded by something like $1 \pm 2e$.
 So, we want to find $p$ that minimizes $\abs{x/x_0 - p\of{x_0x_0y}}$ on $\intclos{1-2e}{1+2e}$.
 NR\footnote{Newton--Raphson, \idest, Newton's method. REMOVE BEFORE FLIGHT: Cite Raphson, cite Lagrange's remarks}
uses the $p = 1$st order Taylor. We know that we can do better via usual approximation theory techniques.

 % https://twitter.com/stephentyrone/status/1057789379052232704
 We can also use higher-order approximations to hit any specific accuracy target in a single step.
 This isn't always better than iterating, but sometimes it is.
\end{quotation}

We do not use a polynomial---nor even a rational function---, nor do we express our refinement as a function of
a quantity bounded by the error.
However, we take advantage of Canon's key idea of
``apply[ing] optimization to the iteration, not just the starting guess''; the latter is what we have so far done
with $Γ$.

The constants $\frac{1}{2}$, $\frac{1}{4}$, and $3$ in Lagny's irrational method may be modified with no effect on
performance; altering the first two of these introduces rounding errors, but these need not concern us here.
We thus write
\[ξ' = κq'+\sqrt{λ{q'}^2+\frac{y-{q'}^3}{μq'}}\]
and choose $Γ$, $κ$, $λ$, and $μ$ minimizing relative error in the Чебышёв norm,\[
\tuple{Γ_{\mathrm{L^2C}}, κ_{\mathrm{L^2C}}, λ_{\mathrm{L^2C}},μ_{\mathrm{L^2C}}}
\DefineAs\argmin_{Γ,κ,λ,μ}\max_{y}\abs{ε_ξ'}\text.\]

Unfortunately, computing $\max_{y} \abs{ε_ξ'}$ is not as easy as for the standard methods;
the introduction of $κ$, $λ$, and $μ$ breaks the monotonicity of $ε_ξ'\of{ε_q'}$,
so that the local extrema of $ε_ξ'$ are not found in the same place as those of $ε_q'$.
Formally looking for zeros of the derivative of $ε_ξ'$ with respect to $f$ is impractical.
Instead we find the local maxima by numerical maximization on the four pieces whereon $q'$
is a smooth function of $f$.

That maximum can be minimized by a straightforward hill-climbing\footnote{It is plausible that some variation
of Ремез's algorithm could be used here, much like it can be adapted to rational functions; since the hill-climbing converged satisfactorily, and did so much faster
than we were writing this document, we have not investigated this.} starting from
$Γ=\frac{1}{10}$, $κ=\frac{1}{2}$, $λ=\frac{1}{4}$, and $μ=3$. We obtain the values
\begin{align*}
Γ_{\mathrm{L^2C}} &\approx 0.10007\,61614\,69941\,46538\,73178\,74111\,71965\,6\text,\\
κ_{\mathrm{L^2C}} &\approx 0.49999\,99381\,08574\,04775\,14291\,72928\,30652\,9\text,\\
λ_{\mathrm{L^2C}} &\approx 0.25000\,00000\,00145\,58487\,81104\,01052\,77249\,3\text,\\
μ_{\mathrm{L^2C}} &\approx 3.00074\,62871\,20756\,72280\,51404\,24030\,90920\text,\\
\end{align*}
for an error of $\max_{y}\abs{ε_ξ'} \approx 2.6157\Multiply10^{-6}$, $\log_2\max_{y}\abs{ε_ξ'} \approx -18.54$: this
optimization gains two bits.
The resulting $ε_ξ'$ is remarkably equioscillating, as can be seen in
figure~\ref{StepTwoComparison}.

With the rewriting (\ref{RewrittenLagnyIrrational}), the constants $1/\sqrt{12}$ and $4$ should
be replaced by\begin{align*}
\sqrt{\frac{1-λ_{\mathrm{L^2C}}μ_{\mathrm{L^2C}}}{μ_{\mathrm{L^2C}}}}
&\approx1/\sqrt{12.01194\,95117\,19793\,69720\,48452\,37177\,0703}\\
&\approx0.28853\,15115\,62316\,71905\,38451\,44194\,38406\,3
\intertext{and}
\frac{1}{1-λ_{\mathrm{L^2C}}μ_{\mathrm{L^2C}}}&\approx4.00298\,73779\,31697\,18250\,67433\,26901\,80421
\end{align*}
respectively.


Note that a similar optimization could be applied to the rational method; however, it
would not unconditionally be free: changing the $2$ in the denominator turns an addition
into a multiplication, and inserting additional constants adds more operations. Whether
this hinders performance depends on the architecture. In any case, the optimization
can scarcely gain more than two bits; such an optimized rational method would still
have double the error of the optimized irrational method.

\subsection{Rounded approximation}

The number $x$ is obtained from $ξ$ by rounding to $\smash{\Floor{\frac{p}{3}}}$ bits.

\subsubsection*{Directed rounding towards zero}
An easy solution is to zero all but the most significant $\smash{\Floor{\frac{p}{3}}}$ bits.
The resulting relative error $\abs{\frac{x}{ξ}-1}$is greatest when the zeroed bits are all $1$ and the
remaining bits (except for the leading $1$) are all $0$; this is the case when the significand of $ξ$ is
$1+2^{-\Floor{\frac{p}{3}}+1}-2^{1-p}$, in which case that of $x$ is $1$, so that\[
\abs{\frac{x}{ξ}-1}\le1-\frac{1}{1+2^{-\Floor{\frac{p}{3}}+1}-2^{1-p}} < 2^{-\Floor{\frac{p}{3}}+1}=2^{-16}\text.
\]
For the error of $x$ as an approximation of the cube root,\[ε_x\DefineAs\frac{x}{\cuberoot{y}}-1\text,\]
we have the bound $\abs{ε_x} < \pa{1+\abs{ε_ξ}}\pa{1+2^{-16}}-1$.

\subsubsection*{Rounding to nearest}
An alternative which has similar performance on some architectures is to round to nearest using Veltkamp's method
TODO CITE.
The rounding error is then bounded by $2^-\Floor{\frac{p}{3}}$ instead, thus
we have the bound $\abs{ε_x} < \pa{1+\abs{ε_ξ}}\pa{1+2^{-17}}-1$.

\subsection{High order iteration}

We compute the faithfully rounded result $r_0$ as the correctly rounded sum of the rounded approximation
and a correction term,\[
r\DefineAs x+Δ\text{, }r_0\DefineAs\round{r}\text,
\]
where the correction term $Δ$ is that of a high-order root finding method.
As usual, we call the infinite-precision correction term $Δ'$, and $r'\DefineAs x+Δ'$.
The truncation error is \[ε_r'\DefineAs\frac{\round{x+Δ'}}{\cuberoot y}-1\text.\]
The rounding error on the correction term is $δ\DefineAs\frac{Δ}{Δ'}-1$.
The error of $r$ is thus\begin{align*}
ε_r\DefineAs&\frac{x+Δ}{\cuberoot y}-1\\
=&\frac{x+Δ'\pa{1+δ}}{\cuberoot y}-1\\
=&\frac{x+Δ'+\pa{x+Δ'-x}δ}{\cuberoot y}-1\\
=&ε_r'+\pa{ε_r'-ε_x}δ\text,
\end{align*}
and that of the faithfully-rounded result $r_0$ is $ε_r\pa{1+υ}$ for some $\abs υ \le u$.

We compute bounds for $ε_{r_0}'$ and $δ$ for two different methods.

\subsubsection*{Fifth order}
We use one iteration of the Lagny--Schröder rational method of order $5$:
\[
\round{x - \round{
\frac{\round{(x^3 - y) \round{\round{\round{\round{10x^3} + 16y}x^3} + \round{y^2}}}}
{\round{x^2 \round{\round{\round{\round{15 x^3} + \round{51 y}}x^3} + \round{15 \round{y^2}}}}}}}
\]
where $x^2$ and $x^3$ are exact thanks to the trailing $0$s of $x$,
$\round{x^6}$ is correctly rounded because it is computed as the square of $x^3$,
and $x^3-y$ is exact by Sterbenz’s lemma.

In infinite precision, this method is of such high order that if $\abs{ε_x} < 14.5$, which is the case
even if $ξ$ is computed by the rational method, the relative error of the result is less than $2^{-75}$.
We will not seek to bound the truncation error more closely, nor to tweak the constants in the method
to optimize it: as we will see, it is dominated by rounding.

Thanks to the exact cube and exact difference, the rounding analysis of the correction term is
straightforward.
All remaining sums being of positive terms, their relative error is readily bounded by the
largest of those of their terms. This leads to bounds of $γ_{5}$ on the numerator and $γ_{5}$ on
the denominator, overall $\frac{1+γ_{6}}{1-γ_{5}}-1<\frac{γ_{11}}{1-γ_{5}}$ on the correction term.

However, considering that our final bound on the error of $x+Δ$, and thus our misrounding estimate,
is proportional to this error, a more careful analysis is warranted.
Observe that $x^3=y\pa{1+ε_x}^3$, so that a sum
\[Σ'=α x^{m}y^{p-m} + β x^{n}y^{p-n}\]
evaluated with terms that carry the errors $δ_i$ as
\[Σ=α x^{m}y^{p-m}\pa{1+δ_1} + β x^{n}y^{p-n}\pa{1+δ_2}\]
has the error\[
\frac{Σ}{Σ'}-1=\frac{\pa{1+ε_x}^{3m}αδ_1+\pa{1+ε_x}^{3n}βδ_2}{\pa{1+ε_x}^{3m}α+\pa{1+ε_x}^{3n}β}\text,
\]
which we may bound


We use one iteration of the Lagny--Schröder rational method of order $6$:\[
r_0\DefineAs\round{x-\round{\frac{
\round{\round{x\pa{x^3-y}}\round{\round{\round{\round{5x^3}+\round{17y}}x^3}+\round{5\round{y^2}}}}}{
\round{\round{\round{\round{7x^3} + \round{42 y}}\round{x^6}}+\round{\round{\round{30x^3}+2y}\round{y^2}}}}}}\text,
\]
where $x^3$ is exact thanks to the trailing $0$s of $x$, $\round{x^6}$ is correctly rounded because it is computed as
the square of $x^3$, and $x^3-y$ is exact by Sterbenz’s lemma.

In infinite precision, this method is of such high order that if $x$ has a relative error
below $2^{-14}$, which is the case here, the relative error of the result is less than
$2^{-100}$; we will not seek to bound the truncation error more closely, nor to tweak $Γ$
nor the method itself to optimize it: as we will see, it is dominated by rounding.

Thanks to the exact cube and exact difference, the rounding analysis is straightforward;
all remaining sums, being of positive terms, have a relative error bounded by the largest of
those of their terms, so that we get no more than $γ_{4}$ on the second factor of the
numerator, $γ_{6}$ on the whole numerator, and similarly $γ_{5}$ on the denominator,
overall $\frac{1+γ_{7}}{1-γ_{5}}-1<\frac{γ_{12}}{1-γ_{5}}$ on the correction term.

Since the relative error of $x$ is at most $\pa{1+ε_ξ}\pa{1+2^{-16}}-1$, the rounding-free
correction term is no larger than $\pa{\pa{1+ε_ξ}\pa{1+2^{-16}}-1}\cuberoot y$, so that the absolute error of the computed correction term is bounded by\[
\frac{γ_{12}}{1-γ_{5}}\pa{\pa{1+ε_ξ}\pa{1+2^{-16}}-1}\cuberoot y\text.
\]
This gives us our bound for the relative error of the result,\[
\abs{\frac{r}{\cuberoot y}-1}<\pa{1+\frac{γ_{12}}{1-γ_{5}}\pa{\pa{1+ε_ξ}\pa{1+2^{-16}}-1}}\pa{1+u}-1\text.
\]
For binary64, this bound is $\displaystyle\abs{\frac{r}{\cuberoot y}-1} < 1.0004336u$.

\section*{Correct rounding}

\appendix
\section{FMA}
\label{FMA}
\section{Rounding error analysis for the second step}
\label{LagnyStepTwoRounding}
\[
ξ\DefineAs
\round{q - \round{\frac{\round{\pa{\round{\round{q^2}q}-y} q}}
                       {\round{2\round{\round{q^2}q}+y}}}}\text.
\]
Note that the subtraction in the numerator is exact by Sterbenz's lemma \cite[\pno~138, theorem~4.3.1]{Sterbenz1974}.

Let $ε_ξ \DefineAs \frac{ξ}{\sqrt[3] y}-1$ and  % TODO(egg): Figure out why \cuberoot does not render here.

It is fairly clear that $ε_ξ'$ dominates the rounding error in the approximation
$ε_ξ\approx ε_ξ'$; for the sake of completeness we quantify this.

Since we have a cancellation in the expression for $ξ$, a little bit of care is
needed to bound those errors.
As mentioned above, $q$ approximates $q'$ to a relative error of at most $3u<γ_3$.
The sum in the denominator\[d\DefineAs\round{2\round{\round{q^2}q}+y}\]has positive terms,
so its relative error with respect to $d'\DefineAs2{q'}^3+y$ is readily bounded,\[
\frac{d}{d'}-1<γ_{3\Multiply3+3}=γ_{12}\text.
\]
The cancelling difference
$b\DefineAs\round{\round{q^2}q}-y$ differs from $b'\DefineAs{q'}^3-y$  by at most
\[δ\DefineAs{q'}^3γ_{3\Multiply3+2}={q'}^3γ_{11}\text,\]
and the numerator $\round{b q}$ from $b'q'$ by at most
\[\pa{\pa{b'+δ}q'\pa{1+γ_3}}\pa{1+γ}-b'q'=\pa{1+γ_4}δq'+γ_4b'q'\text.\]
We can bound the absolute error of the correction term as
\begin{align*}
\abs{\round{\frac{\round{bq}}{d}}-\frac{b'q'}{d'}}<
\frac{b'q'+\pa{1+γ_4}δq'+γ_4b'q'}{d'\pa{1-γ_{12}}}-\frac{b'q'}{d'}
&=\frac{\pa{1+γ_4}δq'+\pa{γ_4+γ_{12}}b'q'}{d'\pa{1-γ_{12}}}\\
&<q'\frac{\pa{1+γ_4}δ+γ_{16}b'}{d'\pa{1-γ_{12}}}\text,
\end{align*}
and that of $ξ$ as 
\[
\abs{ξ-ξ'}<q'\pa{γ_3+\frac{\pa{1+γ_4}δ+γ_{16}b'}{d'\pa{1-γ_{12}}}}\text.
\]
Substituting the truncation errors and the definition of $δ$, we can bound
the relative error arising from rounding:
\[
\abs{\frac{ξ}{ξ'}-1}<
\frac{1+ε_q'}{1+ε_ξ'}
\pa{γ_3+\frac{\pa{1+γ_4}γ_{11}\pa{1+ε_q'}^3+γ_{16}\pa{\pa{1+ε_q'}^3-1}}{(\pa{1+ε_q'}^3+1)+\pa{1-γ_{12}}}}\text.
\]
Linearizing, this bound is $\pa{6+\tfrac{2}{3} + \BigO\of{ε_q'+ε_ξ'}}u+ \BigO\of{u^2}$.
More palatably, for either choice of $γ$, we have\[
\abs{\frac{ξ}{ξ'}-1}<8u
\]
provided that $p\geq 12$.

\section{Performance of Lagny's methods for the cube root}
\label{LagnyIrrationalPerformance}

\section{Other rounding modes}
\label{OtherRoundingModes}

\section{Comparison with other faithful implementations}

\emergencystretch 1em
\end{document}
